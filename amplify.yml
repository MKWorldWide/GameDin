version: 1
applications:
  - frontend:
      phases:
        preBuild:
          commands:
            - npm ci
            - npm run test:ci
        build:
          commands:
            - npm run build
        postBuild:
          commands:
            - npm run generate-sitemap
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
          - .next/cache/**/*
      appRoot: frontend
      customHeaders:
        - pattern: '**/*'
          headers:
            - key: 'Strict-Transport-Security'
              value: 'max-age=31536000; includeSubDomains'
            - key: 'X-Frame-Options'
              value: 'DENY'
            - key: 'X-Content-Type-Options'
              value: 'nosniff'
            - key: 'X-XSS-Protection'
              value: '1; mode=block'
            - key: 'Referrer-Policy'
              value: 'strict-origin-when-cross-origin'
            - key: 'Content-Security-Policy'
              value: "default-src 'self'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"
      cache:
        - patterns:
            - 'public/**/*'
          headers:
            - key: 'Cache-Control'
              value: 'public,max-age=31536000,immutable'
        - patterns:
            - '*.html'
            - '/api/*'
          headers:
            - key: 'Cache-Control'
              value: 'public,max-age=0,must-revalidate'
      redirects:
        - source: '/api/*'
          target: '/api/index.html'
          status: '200'
          condition: null
        - source: '/*'
          target: '/index.html'
          status: '200'
          condition: null

  - backend:
      phases:
        build:
          commands:
            - amplifyPush --simple
            - amplify env checkout prod
      artifacts:
        baseDirectory: amplify/backend
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*
      appRoot: backend 